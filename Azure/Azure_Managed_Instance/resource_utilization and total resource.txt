SELECT  
*
FROM sys.dm_db_resource_stats order by end_time desc

SELECT  
    AVG(avg_cpu_percent) AS 'Average CPU use in percent',
    MAX(avg_cpu_percent) AS 'Maximum CPU use in percent',
    AVG(avg_data_io_percent) AS 'Average data IO in percent',
    MAX(avg_data_io_percent) AS 'Maximum data IO in percent',
    AVG(avg_log_write_percent) AS 'Average log write use in percent',
    MAX(avg_log_write_percent) AS 'Maximum log write use in percent',
    AVG(avg_memory_usage_percent) AS 'Average memory use in percent',
    MAX(avg_memory_usage_percent) AS 'Maximum memory use in percent'
FROM sys.dm_db_resource_stats;

-- CPU_limit is good to azure sql database but inaccurate result for managed instance
-- so use below query to get total values


-- to check total available resources similar to portal

SELECT cpu_rate / 100 as CPU_vCores,
CAST((process_memory_limit_mb) /1024. as DECIMAL(9,1)) as TotalMemoryGB,
CAST((non_sos_mem_gap_mb) /1024. as DECIMAL(9,1)) as NonSOSMemGapGB,
CAST((process_memory_limit_mb - non_sos_mem_gap_mb) /1024. as DECIMAL(9,1)) as TotalAvailableMemoryGB
FROM sys.dm_os_job_object;

