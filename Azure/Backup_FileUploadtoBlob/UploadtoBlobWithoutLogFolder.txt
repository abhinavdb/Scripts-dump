# this script was created for specific requirement where we have to go inside backup folder(ola structure) in local disk and copy only the full and diff backup but not log backup

$storageAccountName = "backupfullltrcontainer"
$containerName = "backupltrfull"
$sourceRootFolder = "F:\SQLBackup\aznetpocdbs01"
$destinationBlobPrefix = "aznetpocdbs01"
$sasToken = "<REDACTED_SAS_TOKEN>"

# Import the Azure.Storage module
Import-Module Az.Storage -Force

# Create a Storage Context with SAS token
$ctx = New-AzStorageContext -StorageAccountName $storageAccountName -SasToken $sasToken

# Function to check if a blob exists in the Azure Storage
function Blob-Exists {
    param (
        [string]$containerName,
        [string]$blobName
    )

    try {
        Get-AzStorageBlob -Container $containerName -Blob $blobName -Context $ctx -ErrorAction Stop
        $true
    } catch {
        $false
    }
}

# Function to recursively copy files from source to destination
function Copy-Files {
    param (
        [string]$sourcePath,
        [string]$destinationPath
    )

    # Get the list of files in the current source directory excluding "LOG" folder
    $sourceFiles = Get-ChildItem -Path $sourcePath -File | Where-Object { $_.FullName -notlike '*\LOG\*' }

    foreach ($file in $sourceFiles) {
        # Determine the relative path for the blob
        $relativePath = $file.FullName.Substring($sourcePath.Length + 1)
        $blobName = "$destinationPath/$relativePath"

        # Check if the blob already exists in Azure Blob Storage
        if (Blob-Exists -containerName $containerName -blobName $blobName) {
            Write-Host "Blob '$blobName' already exists. Skipping."
        } else {
            # Upload the file to Azure Blob Storage
            Set-AzStorageBlobContent -Container $containerName -Blob $blobName -File $file.FullName -Context $ctx
            Write-Host "Uploaded file '$file.FullName' to blob '$blobName'."
        }
    }

    # Recursively copy files from subdirectories
    $subdirectories = Get-ChildItem -Path $sourcePath -Directory | Where-Object { $_.FullName -notlike '*\LOG\*' }
    foreach ($subdirectory in $subdirectories) {
        $relativePath = $subdirectory.FullName.Substring($sourcePath.Length + 1)
        $destinationSubdirectory = "$destinationPath/$relativePath"
        Copy-Files -sourcePath $subdirectory.FullName -destinationPath $destinationSubdirectory
    }
}

# Main loop to create main folders and copy files from "DIFF" and "FULL" folders
$mainFolders = Get-ChildItem -Path $sourceRootFolder -Directory

foreach ($mainFolder in $mainFolders) {
    $mainFolderName = $mainFolder.Name
    $destinationMainFolder = "$destinationBlobPrefix/$mainFolderName"
    Copy-Files -sourcePath $mainFolder.FullName -destinationPath $destinationMainFolder
}
