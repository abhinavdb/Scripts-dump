-- Set up for dynamically generating CREATE TABLE scripts
SET NOCOUNT ON;

-- Temporary table to store generated scripts
CREATE TABLE #GeneratedScripts (
    Script NVARCHAR(MAX)
);

-- Declare variables to hold table information
DECLARE @TableName NVARCHAR(MAX);
DECLARE @SchemaName NVARCHAR(MAX);
DECLARE @SQL NVARCHAR(MAX);

-- Cursor to iterate through all user tables
DECLARE TableCursor CURSOR FOR
SELECT t.TABLE_SCHEMA, t.TABLE_NAME
FROM INFORMATION_SCHEMA.TABLES t
WHERE t.TABLE_TYPE = 'BASE TABLE'
ORDER BY t.TABLE_SCHEMA, t.TABLE_NAME;

OPEN TableCursor;
FETCH NEXT FROM TableCursor INTO @SchemaName, @TableName;

WHILE @@FETCH_STATUS = 0
BEGIN
    -- Generate CREATE TABLE script
    SET @SQL = (
        SELECT 'CREATE TABLE [' + @SchemaName + '].[' + @TableName + '] (
' +
               STRING_AGG(
                   '    [' + c.COLUMN_NAME + '] ' +
                   c.DATA_TYPE +
                   CASE WHEN c.CHARACTER_MAXIMUM_LENGTH IS NOT NULL AND c.DATA_TYPE IN ('CHAR', 'VARCHAR', 'NVARCHAR') THEN
                        '(' +
                        CASE WHEN c.CHARACTER_MAXIMUM_LENGTH = -1 THEN 'MAX'
                             ELSE CAST(c.CHARACTER_MAXIMUM_LENGTH AS NVARCHAR(MAX)) END + ')'
                   ELSE '' END +
                   CASE WHEN c.IS_NULLABLE = 'NO' THEN ' NOT NULL'
                        ELSE ' NULL' END +
                   ISNULL(' DEFAULT ' + COLUMN_DEFAULT, ''),
                   ',
'
               ) +
               ');
'
        FROM INFORMATION_SCHEMA.COLUMNS c
        WHERE c.TABLE_SCHEMA = @SchemaName AND c.TABLE_NAME = @TableName
    );

    -- Insert script into temporary table
    INSERT INTO #GeneratedScripts (Script)
    VALUES (@SQL);

    -- Fetch next table
    FETCH NEXT FROM TableCursor INTO @SchemaName, @TableName;
END;

CLOSE TableCursor;
DEALLOCATE TableCursor;

-- Generate FOREIGN KEY scripts
DECLARE @FKSQL NVARCHAR(MAX);
DECLARE @FKName NVARCHAR(MAX), @ParentSchema NVARCHAR(MAX), @ParentTable NVARCHAR(MAX);
DECLARE @ParentColumn NVARCHAR(MAX), @ReferencedSchema NVARCHAR(MAX), @ReferencedTable NVARCHAR(MAX), @ReferencedColumn NVARCHAR(MAX);

DECLARE ForeignKeyCursor CURSOR FOR
SELECT fk.name AS ForeignKeyName,
       OBJECT_SCHEMA_NAME(fk.parent_object_id) AS ParentSchema,
       OBJECT_NAME(fk.parent_object_id) AS ParentTable,
       colp.name AS ParentColumn,
       OBJECT_SCHEMA_NAME(fk.referenced_object_id) AS ReferencedSchema,
       OBJECT_NAME(fk.referenced_object_id) AS ReferencedTable,
       colr.name AS ReferencedColumn
FROM sys.foreign_keys fk
INNER JOIN sys.foreign_key_columns fkc ON fk.object_id = fkc.constraint_object_id
INNER JOIN sys.columns colp ON fkc.parent_object_id = colp.object_id AND fkc.parent_column_id = colp.column_id
INNER JOIN sys.columns colr ON fkc.referenced_object_id = colr.object_id AND fkc.referenced_column_id = colr.column_id
ORDER BY fk.name, fkc.constraint_column_id;

OPEN ForeignKeyCursor;
FETCH NEXT FROM ForeignKeyCursor INTO @FKName, @ParentSchema, @ParentTable, @ParentColumn, @ReferencedSchema, @ReferencedTable, @ReferencedColumn;

WHILE @@FETCH_STATUS = 0
BEGIN
    SET @FKSQL = 'ALTER TABLE [' + @ParentSchema + '].[' + @ParentTable + '] ADD CONSTRAINT [' + @FKName + '] FOREIGN KEY ([' + @ParentColumn + ']) REFERENCES [' + @ReferencedSchema + '].[' + @ReferencedTable + '] ([' + @ReferencedColumn + ']);';

    -- Insert script into temporary table
    INSERT INTO #GeneratedScripts (Script)
    VALUES (@FKSQL);

    FETCH NEXT FROM ForeignKeyCursor INTO @FKName, @ParentSchema, @ParentTable, @ParentColumn, @ReferencedSchema, @ReferencedTable, @ReferencedColumn;
END;

CLOSE ForeignKeyCursor;
DEALLOCATE ForeignKeyCursor;

-- Generate PRIMARY KEY scripts
DECLARE @PKSQL NVARCHAR(MAX);
DECLARE @PKName NVARCHAR(MAX), @PKSchema NVARCHAR(MAX), @PKTable NVARCHAR(MAX), @PKColumn NVARCHAR(MAX);
DECLARE @CurrentPK NVARCHAR(MAX) = '';

DECLARE PrimaryKeyCursor CURSOR FOR
SELECT i.name AS PrimaryKeyName,
       OBJECT_SCHEMA_NAME(i.object_id) AS TableSchema,
       OBJECT_NAME(i.object_id) AS TableName,
       col.name AS ColumnName
FROM sys.indexes i
INNER JOIN sys.index_columns ic ON i.object_id = ic.object_id AND i.index_id = ic.index_id
INNER JOIN sys.columns col ON ic.object_id = col.object_id AND ic.column_id = col.column_id
WHERE i.is_primary_key = 1
ORDER BY i.name, ic.key_ordinal;

OPEN PrimaryKeyCursor;
FETCH NEXT FROM PrimaryKeyCursor INTO @PKName, @PKSchema, @PKTable, @PKColumn;

WHILE @@FETCH_STATUS = 0
BEGIN
    IF @CurrentPK <> @PKName
    BEGIN
        IF @PKSQL <> ''
        BEGIN
            SET @PKSQL = @PKSQL + ');';
            INSERT INTO #GeneratedScripts (Script)
            VALUES (@PKSQL);
        END
        SET @PKSQL = 'ALTER TABLE [' + @PKSchema + '].[' + @PKTable + '] ADD CONSTRAINT [' + @PKName + '] PRIMARY KEY ([' + @PKColumn + ']';
        SET @CurrentPK = @PKName;
    END
    ELSE
    BEGIN
        SET @PKSQL = @PKSQL + ', [' + @PKColumn + ']';
    END

    FETCH NEXT FROM PrimaryKeyCursor INTO @PKName, @PKSchema, @PKTable, @PKColumn;
END;

IF @PKSQL <> ''
BEGIN
    SET @PKSQL = @PKSQL + ');';
    INSERT INTO #GeneratedScripts (Script)
    VALUES (@PKSQL);
END;

CLOSE PrimaryKeyCursor;
DEALLOCATE PrimaryKeyCursor;

-- Output all scripts in grid format
SELECT Script FROM #GeneratedScripts;

-- Clean up
DROP TABLE #GeneratedScripts;